<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Pesanan dari Reseller</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 10px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    div#orders-list > div {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }

    strong {
      color: #333;
    }
  </style>
</head>
<body>
  <h1>Pesanan dari Reseller</h1>
  <div id="orders-list">Memuat data...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAsnbwmKyJaN9GA--95k_bhwTeYyoIkvE4",
      authDomain: "reseller-form-a616f.firebaseapp.com",
      databaseURL: "https://reseller-form-a616f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "reseller-form-a616f",
      storageBucket: "reseller-form-a616f.appspot.com",
      messagingSenderId: "194922134187",
      appId: "1:194922134187:web:6e2421004dc4ba580195ee",
      measurementId: "G-NHLWZHWWEW"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const resellerName = urlParams.get('resellerName') || "";
    const resellerEmail = urlParams.get('resellerEmail') || "";
    const resellerPhone = urlParams.get('resellerPhone') || "";

    const ordersRef = ref(database, 'orders');

    onValue(ordersRef, (snapshot) => {
      const orders = snapshot.val();
      const ordersList = document.getElementById('orders-list');

      if (!orders) {
        ordersList.innerHTML = '<p>Tidak ada data.</p>';
        return;
      }

      ordersList.innerHTML = '';

      Object.keys(orders).forEach((orderId) => {
        const order = orders[orderId];

        // Filter jika ada parameter dari URL
        if ((resellerName && order.resellerName !== resellerName) ||
            (resellerEmail && order.resellerEmail !== resellerEmail) ||
            (resellerPhone && order.resellerPhone !== resellerPhone)) {
          return;
        }

        const formatRupiah = (value) => {
          const num = parseInt(value);
          return isNaN(num) ? '-' : 'Rp' + num.toLocaleString('id-ID');
        };

        const formattedDate = new Intl.DateTimeFormat('id-ID', {
          day: '2-digit', month: '2-digit', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        }).format(new Date(order.timestamp));

        const status = order.status || 'Belum Dikonfirmasi';

        const orderElement = document.createElement('div');
        orderElement.innerHTML = `
          <p><strong>Nama Reseller:</strong> ${order.resellerName || '-'}</p>
          <p><strong>Email Reseller:</strong> ${order.resellerEmail || '-'}</p>
          <p><strong>Telepon Reseller:</strong> ${order.resellerPhone || '-'}</p>
          <hr>
          <p><strong>Nama Pemesan:</strong> ${order.name}</p>
          <p><strong>Email Pemesan:</strong> ${order.email}</p>
          <p><strong>Alamat:</strong> ${order.address}</p>
          <p><strong>Alamat Domisili:</strong> ${order.domisili}</p>
          <p><strong>Kode Pos:</strong> ${order.kodePos}</p>
          <p><strong>Pekerjaan:</strong> ${order.pekerjaan}</p>
          <p><strong>Pendapatan/Bulan:</strong> ${formatRupiah(order.pendapatan)}</p>
          <p><strong>Angsuran Lain:</strong> ${order.angsuran || '-'}</p>
          <p><strong>Nomor Telepon:</strong> ${order.phone}</p>
          <p><strong>Barang:</strong> ${order.item}</p>
          <p><strong>DP:</strong> ${formatRupiah(order.dp)}</p>
          <p><strong>Waktu Pemesanan:</strong> ${formattedDate}</p>
          <p><strong>Status Pengajuan:</strong> ${status}</p>
        `;
        ordersList.appendChild(orderElement);
      });
    });
  </script>
</body>
</html>
