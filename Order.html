<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Pesanan dari Reseller</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 10px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    div#orders-list > div {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      background: #f9f9f9;
    }

    strong {
      color: #333;
    }

    hr {
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <h1>Pesanan dari Reseller</h1>
  <div id="orders-list">Memuat data...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAsnbwmKyJaN9GA--95k_bhwTeYyoIkvE4",
      authDomain: "reseller-form-a616f.firebaseapp.com",
      databaseURL: "https://reseller-form-a616f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "reseller-form-a616f",
      storageBucket: "reseller-form-a616f.appspot.com",
      messagingSenderId: "194922134187",
      appId: "1:194922134187:web:6e2421004dc4ba580195ee",
      measurementId: "G-NHLWZHWWEW"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const resellerName = urlParams.get('resellerName') || "";
    const resellerEmail = urlParams.get('resellerEmail') || "";
    const resellerPhone = urlParams.get('resellerPhone') || "";

    const ordersRef = ref(database, 'orders');
    const ordersList = document.getElementById('orders-list');

    const formatRupiah = (value) => {
      const num = parseInt(value);
      return isNaN(num) ? '-' : 'Rp' + num.toLocaleString('id-ID');
    };

    const escapeHTML = (str) => {
      if (typeof str !== 'string') return str;
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    try {
      onValue(ordersRef, (snapshot) => {
        const orders = snapshot.val();
        ordersList.innerHTML = '';

        if (!orders) {
          ordersList.textContent = 'Tidak ada data.';
          return;
        }

        Object.keys(orders).forEach((orderId) => {
          const order = orders[orderId];

          // Filter berdasarkan reseller
          if ((resellerName && order.resellerName !== resellerName) ||
              (resellerEmail && order.resellerEmail !== resellerEmail) ||
              (resellerPhone && order.resellerPhone !== resellerPhone)) {
            return;
          }

          const formattedDate = new Intl.DateTimeFormat('id-ID', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
          }).format(new Date(order.timestamp));

          const status = order.status || 'Belum Dikonfirmasi';

          const div = document.createElement('div');
          div.innerHTML = `
            <p><strong>Nama Reseller:</strong> ${escapeHTML(order.resellerName || '-')}</p>
            <p><strong>Email Reseller:</strong> ${escapeHTML(order.resellerEmail || '-')}</p>
            <p><strong>Telepon Reseller:</strong> ${escapeHTML(order.resellerPhone || '-')}</p>
            <hr>
            <p><strong>Nama Pemesan:</strong> ${escapeHTML(order.name || '-')}</p>
            <p><strong>Email Pemesan:</strong> ${escapeHTML(order.email || '-')}</p>
            <p><strong>Alamat:</strong> ${escapeHTML(order.address || '-')}</p>
            <p><strong>Alamat Domisili:</strong> ${escapeHTML(order.domisili || '-')}</p>
            <p><strong>Kode Pos:</strong> ${escapeHTML(order.kodePos || '-')}</p>
            <p><strong>Pekerjaan:</strong> ${escapeHTML(order.pekerjaan || '-')}</p>
            <p><strong>Pendapatan/Bulan:</strong> ${formatRupiah(order.pendapatan)}</p>
            <p><strong>Angsuran Lain:</strong> ${escapeHTML(order.angsuran || '-')}</p>
            <p><strong>Nomor Telepon:</strong> ${escapeHTML(order.phone || '-')}</p>
            <p><strong>Barang:</strong> ${escapeHTML(order.item || '-')}</p>
            <p><strong>DP:</strong> ${formatRupiah(order.dp)}</p>
            <p><strong>Waktu Pemesanan:</strong> ${formattedDate}</p>
            <p><strong>Status Pengajuan:</strong> ${escapeHTML(status)}</p>
          `;
          ordersList.appendChild(div);
        });
      });
    } catch (err) {
      ordersList.textContent = 'Terjadi kesalahan saat memuat data.';
      console.error("Firebase error:", err);
    }
  </script>
</body>
</html>
